# 02. ネットワーク設計

## 採用AWSサービス（本章該当）

| サービス名      | 用途                           |
|------------------|--------------------------------|
| VPC              | 仮想ネットワーク基盤           |
| Subnet           | AZ分散構成のプライベートサブネット |
| VPC Endpoint     | S3（Gateway）や各種サービス（Interface）への内部接続  |
| Route Table      | VPC内トラフィック制御           |
| Direct Connect    | OCIとの専用接続                 |
| Security Group   | 各サービスの接続許可制御        |

---

## 1. VPC構成

本システムは、`bi-vpc` という専用VPC上に構築されている。  
このVPCは、**プライベートサブネットのみ**を使用しており、**インターネットへの直接的なアクセス経路（NAT Gatewayなど）はない**。

### サブネット構成

| AZ                | サブネット名                                | 用途                     |
|-------------------|---------------------------------------------|--------------------------|
| ap-northeast-1a   | bi-subnet-private1-ap-northeast-1a          | Redshiftなどの配置先、冗長構成 |
| ap-northeast-1c   | bi-subnet-private2-ap-northeast-1c          | Redshiftなどの配置先、冗長構成 |

- **全てプライベートサブネット**
- **可用性向上のためにAZ分散**
- **パブリックサブネット／NAT Gatewayなし**

---

## 2. ルーティングとエンドポイント

### ルートテーブル詳細

各プライベートサブネットに関連付けられたルートテーブルは以下のとおりである。  
いずれも VPC エンドポイントおよび VGW（Direct Connect経由）へのルートを持つ。

#### ap-northeast-1a（bi-rtb-private1-ap-northeast-1a）

| 宛先           | ターゲット              | 用途／備考                                   |
|----------------|-------------------------|----------------------------------------------|
| pl-61a54008    | vpce-06c2c6e45474ab777 | S3向け VPC エンドポイント（Prefix list 宛先） |
| 10.0.0.0/16    | local                   | 自VPC内ルート                                |
| 10.0.0.0/8     | vgw-0e397d12571339921  | Direct Connect（OCI宛）                      |
| 172.16.0.0/12  | vgw-0e397d12571339921  | Direct Connect（OCI宛）                      |
| 192.168.0.0/16 | vgw-0e397d12571339921  | Direct Connect（OCI宛）                      |

#### ap-northeast-1c（bi-rtb-private2-ap-northeast-1c）

| 宛先           | ターゲット              | 用途／備考                                   |
|----------------|-------------------------|----------------------------------------------|
| pl-61a54008    | vpce-06c2c6e45474ab777 | S3向け VPC エンドポイント（Prefix list 宛先） |
| 10.0.0.0/16    | local                   | 自VPC内ルート                                |
| 10.0.0.0/8     | vgw-0e397d12571339921  | Direct Connect（OCI宛）                      |
| 172.16.0.0/12  | vgw-0e397d12571339921  | Direct Connect（OCI宛）                      |
| 192.168.0.0/16 | vgw-0e397d12571339921  | Direct Connect（OCI宛）                      |

### ポイント
- **S3通信**はS3 Gateway Endpoint（vpce-06c2c6e45474ab777、宛先 pl-61a54008）経由で完結し、インターネットを経由しない。
- **OCI連携**はVGW（`vgw-0e397d12571339921`）を経由し、閉域網で接続する。対象CIDRは10.0.0.0/8、172.16.0.0/12、192.168.0.0/16のプライベートアドレス帯である。  

---

## 3. VPCエンドポイント

### Gateway Endpoint（S3）

| サービス名 | エンドポイント名 |
|------------|------------------|
| S3         | bi-vpce-s3       |

- S3との通信は **VPC内で完結**（Glueジョブ等からのアクセスを想定）

---

## 4. セキュリティグループ

- Redshift, Lambda, Glue等は**最小権限原則に基づいたSG設計**。
- セキュリティグループは ENI単位で適用。サブネット境界の制御は NACL で補完。
- 通常、**外部（インターネット）向け開放は一切なし**。

---

## 5. 外部接続：OCI接続（FIC＋DirectConnect）

本システムは、OCI上の売買情報DBと接続するため、**FIC経由でDirectConnectを利用**している。  
この接続は **閉域網で構成されており、VPC内プライベートサブネットとセキュアに連携**する。

---

## 6. 補足事項

- DNS解決はVPC内のAmazonProvidedDNSを使用
- プロキシやNATを用いず、すべて**内部ルート・内部サービス連携**で構成

---

[前の章へ](01_architecture.md)｜[目次へ](README.md)｜[次の章へ](03_compute.md)
